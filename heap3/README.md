#1-Heap3
- Đây là lỗi tràn bộ nhớ heap xem chương trình như thế nào
```
void winner()
{
  printf("that wasn't too bad now, was it? @ %d\n", time(NULL));
}

int main(int argc, char **argv)
{
  char *a, *b, *c;

  a = malloc(32);
  b = malloc(32);
  c = malloc(32);

  strcpy(a, argv[1]);
  strcpy(b, argv[2]);
  strcpy(c, argv[3]);

  free(c);
  free(b);
  free(a);

  printf("dynamite failed?\n");
}
```
- Ý tưởng: Bài này em lợi dụng lỗ hổng của free. Tạo 1 đoạn mã trên bộ nhớ đệm của B để lừa chương trình rằng bộ nhớ của A đang free khi đó chương trình sẽ gọi hàm unlink để xóa đoạn mã đó nhưng ta có thể điều hướng tới bộ nhớ đệm của A chứa shell code để thực thi gọi hàm winner.
- Đầu tiên không quan tâm tham số truyền vào của C mọi thao tác đều làm trên A và B.
- Cấu trúc ngăn heap
![Screenshot 2022-03-29 010633](https://i.imgur.com/NAYFHKC.png)
- Bộ nhớ đệm B : pre_size = -8 vì hàm Chunk_free() sẽ tính toán bằng cách gọi hàm chunk_at_offset(p,-(long)prevsz) để chương trình tin rằng đoạn trước đó bắt đầu bằng độ lệch 8 byte phía trước khi B băt đầu ; size = -4 dùng để đánh lừa phần trước đó đã free và để chương trình hiểu rằng kích thước của phần liền kề là 4byte 
- Địa chỉ puts() 
![Screenshot 2022-03-29 011818](https://i.imgur.com/152KB0V.png)
-Nhưng để ý hàm unlink()
```
#define unlink( P, BK, FD ) {            
    BK = P->bk;                          
    FD = P->fd;                          
    FD->bk = BK;                         
    BK->fd = FD;                         
}
```
- Vì trường bk đặt cách 12byte so với đầu của mỗi đoạn nên địa chỉ thật của puts() là
```
>>>hex(0x0804b128-12)
>>>0x0804b11c
```
- Bài này dùng tấn công NOP sled để trượt vào shell code
- Địa chỉ của NOP sled 0x804c008
![Screenshot 2022-03-29 012404](https://i.imgur.com/Y3MjfYP.png)
- Xong đến bộ nhớ đệm A lúc này chương trình đã bị lừa trượt vào NOP rồi thực hiện shell code thôi
- Shell code là chạy vào hàm winner và trả về chính nó, tìm địa chỉ của winner là shell code diassembly trên web là hoàn thành
![Screenshot 2022-03-29 012724](https://i.imgur.com/i5QgDa8.png)
![Screenshot 2022-03-29 012754](https://i.imgur.com/xSvjVsD.png)
- Kết quả
![Screenshot 2022-03-29 013202](https://i.imgur.com/NhRJmku.png)

